<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RushSafe</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" crossorigin />
  <style>
    :root{ --bg:#0b1520; --panel:#111a26; --muted:#8fb3ff; --text:#e6f0ff; --accent:#5aa7ff; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{display:flex;align-items:center;gap:.75rem;padding:.8rem 1rem;border-bottom:1px solid #22324a;background:linear-gradient(180deg,#0e1a2a,#0b1520)}
    header h1{font-size:1.05rem;margin:0;font-weight:700;letter-spacing:.2px}
    #map{position:fixed;inset:64px 0 0 0}
    .panel{position:fixed;top:64px;left:12px;z-index:500;background:var(--panel);border:1px solid #1f2d43;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:.75rem;width:min(520px,calc(100vw - 24px));max-height:calc(100vh - 80px);overflow:auto}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0}
    button,.btn{cursor:pointer;border:none;border-radius:12px;padding:.7rem .9rem;font-weight:600;font-size:.94rem;background:#15253a;color:var(--text);outline:1px solid #1f334d}
    button:hover,.btn:hover{filter:brightness(1.05)}
    .primary{background:linear-gradient(180deg,#2a62ff,#1e46b8);outline:none}
    .success{background:linear-gradient(180deg,#22c55e,#16a34a)}
    .warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    .danger{background:linear-gradient(180deg,#ef4444,#dc2626)}
    .ghost{background:#101a2a}
    input,select,textarea{width:100%;padding:.6rem .7rem;border-radius:10px;border:1px solid #1f334d;background:#0c1727;color:var(--text)}
    label{font-size:.85rem;color:#aac0ff;margin:.35rem 0 .2rem;display:block}
    .kicker{font-size:.8rem;color:#a3b5d9}
    .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .55rem;border-radius:999px;background:#12223a;border:1px solid #1f334d;font-size:.75rem;color:#b7cbff}
    details{border:1px dashed #27456f;border-radius:12px;padding:.4rem .6rem}
    details[open]{background:#0e1a20}
    .toast{position:fixed;right:14px;bottom:14px;z-index:1000;background:#12223a;border:1px solid #20406b;color:#e7f0ff;padding:.7rem 1rem;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .divider{height:1px;background:#20324d;margin:.6rem 0}
    .note{font-size:.8rem;color:#b8c7e6}
    .right{margin-left:auto}
    .hidden{display:none!important}
    ul.slim{margin:.4rem 0 .8rem;padding-left:1.1rem;max-height:140px;overflow:auto}
    ul.slim li{margin:.12rem 0}
    .tag{display:inline-block;padding:.15rem .4rem;border:1px solid #25406a;border-radius:999px;font-size:.72rem;color:#bcd0ff;background:#0f1a2b}
    .acc{color:#9be7ff}
    dialog.modal{border:none;border-radius:16px;max-width:560px;width:92%;background:#0b1520;color:var(--text);padding:0}
    dialog .wrap{padding:1rem 1rem 1.25rem}
    .med{color:#9bf5ff}
  </style>
</head>
<body>
  <header>
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l9 6v8l-9 6-9-6V8l9-6z" fill="#5aa7ff" opacity=".85"/><path d="M12 7l6 4v6l-6 4-6-4v-6l6-4z" fill="#2d3e58"/></svg>
    <h1>RushSafe</h1>
    <span class="pill right" id="statusPill">⏳ starting…</span>
  </header>

  <div id="map" role="application" aria-label="Shelter map"></div>

  <section class="panel" aria-label="Controls">
    <div class="row">
      <button class="primary" id="btnLocate">📍 Locate me</button>
      <button class="success" id="btnNearest">🛡️ Nearest shelter</button>
      <button class="warn" id="btnRoute">🗺️ Route on map</button>
      <button class="ghost" id="btnWaze">🚘 Waze</button>
      <button class="ghost" id="btnGmaps">🗺️ Google Maps</button>
    </div>

    <details open>
      <summary><b>🚨 Emergency mode</b></summary>
      <div class="row">
        <label class="pill">Group size <input id="groupSize" type="number" min="1" value="1" style="width:74px;margin-left:.4rem"></label>
        <button id="btnEmergency" class="danger">Auto-route me now</button>
      </div>
      <p class="note">Emergency mode prefers <i>accessible & open</i> shelters with space if your profile indicates wheelchair use.</p>
    </details>

    <div class="divider"></div>

    <h3>Contacts & safety</h3>
    <p class="kicker">Numbers are stored locally; “I’m safe” only confirms success (no real messages sent).</p>
    <input id="contactsInput" placeholder="e.g. +97250..., +97252..." />
    <div class="row">
      <button id="btnSaveContacts">Save contacts</button>
      <button id="btnSafe" class="success">✅ I'm safe</button>
      <button id="btnWhatsApp" class="ghost">💬 WhatsApp (optional)</button>
    </div>
    <p id="safeStatus" class="note">Status: not sent</p>

    <div class="divider"></div>

    <h3>Profile & accessibility</h3>
    <div class="row">
      <label class="pill"><input type="checkbox" id="wheelchairChk"> Wheelchair user</label>
      <label class="pill"><input type="checkbox" id="lowVisionChk"> Low vision</label>
    </div>
    <label for="healthNotes">Health notes (optional)</label>
    <textarea id="healthNotes" rows="2" placeholder="e.g., needs elevator, asthma, etc."></textarea>
    <div class="row"><button id="btnSaveProfile">💾 Save profile</button></div>

    <div class="divider"></div>

    <h3>Data: official/community</h3>
    <div class="row">
      <button id="btnLoadIsraelMock">🇮🇱 Load Israel mock</button>
      <button id="btnLoadJerusalem">🕍 Load Jerusalem (official GeoJSON)</button>
      <button id="btnLoadSample">📦 Add tiny sample</button>
      <button id="btnClearShelters" class="danger">🗑️ Clear</button>
    </div>
    <label>Load from URL (JSON/GeoJSON/CSV)</label>
    <input id="urlInput" placeholder="https://.../shelters.geojson" />
    <div class="row"><button id="btnFetchUrl">🌐 Load from URL</button><input type="file" id="fileImport" accept=".json,.geojson,.csv" class="hidden"/><button id="btnImport">⬆️ Import file</button></div>
    <label>Paste JSON/CSV</label>
    <textarea id="pasteBox" rows="5"></textarea>
    <div class="row"><button id="btnParsePaste">➕ Add from pasted data</button></div>

    <div class="divider"></div>

    <h3>Lists</h3>
    <p class="kicker">Accessible shelters (♿) vs standard shelters.</p>
    <div class="row"><button id="btnRefreshLists" class="ghost">↻ Refresh lists</button></div>
    <b class="acc">Accessible shelters (♿)</b>
    <ul id="listAccessible" class="slim"></ul>
    <b>Standard shelters</b>
    <ul id="listStandard" class="slim"></ul>

    <div class="divider"></div>

    <h3><span class="med">Medical supplements</span></h3>
    <p class="kicker">Community-added locations of AED/CPR device, first-aid kit, EpiPen, oxygen, etc.</p>
    <div class="row">
      <button id="btnAddMed" class="ghost">➕ Add medical supplement</button>
      <button id="btnNeedMed" class="danger">🆘 I need medical supplements</button>
    </div>
    <ul id="listMeds" class="slim"></ul>

    <div class="divider"></div>

    <h3>Account & private shelter</h3>
    <p class="kicker">Register to add a private shelter (demo).</p>
    <div class="row"><input id="email" placeholder="Email" style="flex:1"><input id="displayName" placeholder="Name" style="flex:1"></div>
    <div class="row"><button id="btnRegister">🪪 Register / Sign-in (demo)</button><button id="btnAddShelter">➕ Add my private shelter</button></div>

    <div class="divider"></div>

    <h3>Selected shelter</h3>
    <p class="kicker" id="selShelter">None</p>
    <div class="row">
      <button id="btnShareLink" class="ghost">🔗 Share link</button>
      <button id="btnToggleOpen" class="ghost">📣 Toggle Open/Closed</button>
      <button id="btnUpdateCount" class="ghost">👥 Update people count</button>
    </div>
    <p class="note">Marker colors: <b style="color:#22c55e">green</b> (&lt;50%), <b style="color:#f59e0b">orange</b> (50–85%), <b style="color:#ef4444">red</b> (≥85% or closed).</p>
  </section>

  <!-- Add Shelter Modal -->
  <dialog id="dlgAdd" class="modal">
    <form method="dialog" class="wrap">
      <h3 style="margin:.2rem 0 .2rem">Add my shelter</h3>
      <p class="kicker">Use your current GPS, or click "Pick on map" to choose a location.</p>
      <label for="name">Name</label>
      <input id="name" placeholder="e.g., Private mamad – Apt 12" required />
      <div class="row">
        <div style="flex:1"><label for="capacity">Capacity</label><input id="capacity" type="number" min="1" step="1" placeholder="e.g., 8"/></div>
        <div style="flex:1"><label for="contact">Contact link</label><input id="contact" placeholder="tel:+972..., https://..." /></div>
      </div>
      <div class="row">
        <button id="btnUseGPS" class="ghost" type="button">📍 Use my GPS</button>
        <button id="btnPickOnMap" class="ghost" type="button">🗺️ Pick on map</button>
      </div>
      <input id="lat" placeholder="Latitude" />
      <input id="lng" placeholder="Longitude" />
      <label class="pill"><input type="checkbox" id="accessibleChk"> Accessible (step-free)</label>
      <label for="photo">Entrance photo (optional)</label>
      <input id="photo" type="file" accept="image/*" />
      <div class="row" style="justify-content:flex-end;margin-top:.6rem">
        <button class="ghost" value="cancel">Cancel</button>
        <button class="primary" id="btnSaveShelter" value="default">Save shelter</button>
      </div>
      <p class="note">By adding, you confirm people may navigate to this point in emergencies. Do not add restricted or unsafe places.</p>
    </form>
  </dialog>

  <!-- Add Medical Supplement Modal -->
  <dialog id="dlgAddMed" class="modal">
    <form method="dialog" class="wrap">
      <h3 style="margin:.2rem 0 .2rem">Add medical supplement</h3>
      <p class="kicker">Publicly accessible items only (e.g., AED/CPR device, first-aid kit, EpiPen, oxygen).</p>
      <label>Name</label>
      <input id="medName" placeholder="e.g., AED / CPR device" required />
      <label>Type</label>
      <input id="medType" placeholder="AED, First-aid kit, EpiPen, Oxygen…" required />
      <div class="row">
        <div style="flex:1"><label>Notes (optional)</label><input id="medNotes" placeholder="Floor, landmark, hours"/></div>
        <div style="flex:1"><label>Contact (optional)</label><input id="medContact" placeholder="tel:+972..., https://..."/></div>
      </div>
      <div class="row">
        <button id="btnUseGPSMed" class="ghost" type="button">📍 Use my GPS</button>
        <button id="btnPickOnMapMed" class="ghost" type="button">🗺️ Pick on map</button>
      </div>
      <input id="medLat" placeholder="Latitude" />
      <input id="medLng" placeholder="Longitude" />
      <div class="row" style="justify-content:flex-end;margin-top:.6rem">
        <button class="ghost" value="cancel">Cancel</button>
        <button class="primary" id="btnSaveMed" value="default">Save</button>
      </div>
      <p class="note">Only add if this location is safe and allowed to be shared publicly.</p>
    </form>
  </dialog>

  <!-- Need Medical Modal -->
  <dialog id="dlgNeedMed" class="modal">
    <div class="wrap">
      <h3>🆘 I need medical supplements</h3>
      <label>Filter by type</label>
      <select id="medTypeFilter"><option value="">All types</option></select>
      <div class="row">
        <button id="btnNearestMed" class="primary">Find nearest</button>
        <button id="btnCloseNeed" class="ghost right">Close</button>
      </div>
      <ul id="needMedList" class="slim"></ul>
      <p class="note">Tip: select a type (e.g., AED) then “Find nearest”, or click “Route” next to any item.</p>
    </div>
  </dialog>

  <!-- Emergency Instructions Modal -->
  <dialog id="dlgInstructions" class="modal">
    <div class="wrap">
      <h3>⚠️ No suitable shelter nearby</h3>
      <p>Follow these quick safety steps:</p>
      <ul>
        <li>Enter the nearest stairwell or interior room without windows.</li>
        <li>Lie down and <b>cover your head with your hands</b>.</li>
        <li>Stay away from windows and exterior walls.</li>
        <li>If outside: lie flat, protect your head, seek cover behind a solid object.</li>
        <li>Wait for the all-clear; follow official guidance.</li>
      </ul>
      <div class="row" style="justify-content:flex-end">
        <button id="btnCloseInstr" class="primary">OK</button>
      </div>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js" crossorigin></script>
  <script>
    // ===== Tiny helpers
    const $ = sel => document.querySelector(sel);
    const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); clearTimeout(t._id); t._id=setTimeout(()=>t.classList.add('hidden'), 2000)};
    const statusPill = (txt, emoji='⏳') => { $('#statusPill').textContent = `${emoji} ${txt}` };

    // ===== Map init
    const map = L.map('map', { zoomControl: true }).setView([31.771959, 35.217018], 8); // Israel center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

    const markers = L.layerGroup().addTo(map);        // shelters
    const medLayer = L.layerGroup().addTo(map);       // medical supplements
    let meMarker = null;
    let targetMarker = null;

    // Routing
    const router = L.Routing.control({
      waypoints: [],
      router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
      addWaypoints: false,
      routeWhileDragging: false,
      draggableWaypoints: false,
      show: false,
      fitSelectedRoutes: true
    }).addTo(map);

    // ===== Storage
    const store = {
      get shelters(){ return JSON.parse(localStorage.getItem('shelters_v3')||'[]') },
      set shelters(v){ localStorage.setItem('shelters_v3', JSON.stringify(v)); renderShelters(); renderShelterLists(); },
      get medSupps(){ return JSON.parse(localStorage.getItem('medsupp_v1')||'[]') },
      set medSupps(v){ localStorage.setItem('medsupp_v1', JSON.stringify(v)); renderMedSupps(); renderMedList(); },
      get contacts(){ return localStorage.getItem('contacts_v2') || '' },
      set contacts(v){ localStorage.setItem('contacts_v2', v) },
      get user(){ return JSON.parse(localStorage.getItem('user_v2')||'null') },
      set user(v){ localStorage.setItem('user_v2', JSON.stringify(v)) },
      get profile(){ return JSON.parse(localStorage.getItem('profile_v1')||'null') || { wheelchair:false, lowVision:false, healthNotes:'' } },
      set profile(v){ localStorage.setItem('profile_v1', JSON.stringify(v)) }
    };

    // ===== Geolocation
    let myPos = null;
    async function locateMe(force=false){
      statusPill('locating…','⏳');
      return new Promise((resolve,reject)=>{
        if(!navigator.geolocation){ toast('Geolocation not supported by this browser'); statusPill('no GPS','⚠️'); return reject(new Error('no geolocation')) }
        const opts = { enableHighAccuracy:true, timeout: 15000, maximumAge: force?0:10000 };
        navigator.geolocation.getCurrentPosition((pos)=>{
          const {latitude, longitude} = pos.coords;
          myPos = [latitude, longitude];
          if(meMarker){ meMarker.setLatLng(myPos) } else { meMarker = L.marker(myPos,{title:'You'}).addTo(map).bindPopup('📍 You are here'); }
          map.setView(myPos, 15);
          statusPill(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`,'📍');
          resolve(myPos);
        }, (err)=>{
          toast('GPS error: '+err.message+ ' (Tip: run via Live Server & allow location)');
          statusPill('GPS failed','⚠️'); reject(err)
        }, opts);
      })
    }

    // ===== Marker icons
    function occupancyColor(capacity, count, open){
      if(open===false) return '#6b7280';
      if(!capacity || capacity<=0) return '#22c55e';
      const ratio = (count||0)/capacity;
      if(ratio>=0.85) return '#ef4444';
      if(ratio>=0.5) return '#f59e0b';
      return '#22c55e';
    }
    function circleIcon(color){
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><circle cx='16' cy='16' r='12' fill='${color}' stroke='black' stroke-width='2'/></svg>`);
      return L.icon({ iconUrl:`data:image/svg+xml,${svg}`, iconSize:[24,24], iconAnchor:[12,12] });
    }
    function medIcon(){
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'>
        <circle cx='16' cy='16' r='12' fill='#0ea5e9' stroke='black' stroke-width='2'/>
        <rect x='14' y='8' width='4' height='16' fill='white'/><rect x='8' y='14' width='16' height='4' fill='white'/>
      </svg>`);
      return L.icon({ iconUrl:`data:image/svg+xml,${svg}`, iconSize:[24,24], iconAnchor:[12,12] });
    }

    // ===== Shelters rendering
    function renderShelters(){
      markers.clearLayers();
      store.shelters.forEach(s=>{
        const color = occupancyColor(s.capacity, s.count, s.open!==false);
        const m = L.marker([s.lat, s.lng], { title:s.name, icon: circleIcon(color) });
        const occ = s.capacity?`${s.count||0}/${s.capacity}`:'—';
        const statusTxt = (s.open===false)?'<span style="color:#ddd">Closed</span>':'<span style="color:#22c55e">Open</span>';
        const accTag = s.accessible ? " <span class='tag'>♿ Accessible</span>" : " <span class='tag'>Standard</span>";
        const contact = s.contact?`<a class='link' target='_blank' href='${s.contact}'>Contact</a>`:'No contact';
        const photo = s.photoUrl?`<br><img src='${s.photoUrl}' alt='entrance' style='width:100%;max-width:220px;border-radius:8px;margin-top:.4rem'>`:'';
        m.bindPopup(`<b>${escapeHtml(s.name)}</b>${accTag}<br/>Status: ${statusTxt}<br/>Capacity: ${occ}<br/>${contact}${photo}
        <div style="margin-top:.4rem;display:flex;gap:.4rem;flex-wrap:wrap">
          <button class='btn' onclick="window._app.routeTo(${s.lat},${s.lng}, '${encodeURIComponent(s.name)}')">Route</button>
          <button class='btn' onclick="window._app.openInWaze(${s.lat},${s.lng})">Waze</button>
          <button class='btn' onclick="window._app.shareOne(${s.lat},${s.lng},'${encodeURIComponent(s.name)}')">Share</button>
        </div>`);
        m.on('click', ()=> selectShelter(s));
        m.addTo(markers);
      })
    }

    function renderShelterLists(){
      const acc = store.shelters.filter(s => s.accessible === true);
      const std = store.shelters.filter(s => s.accessible !== true);
      const mkItem = (s)=> `<li>${escapeHtml(s.name)} <span class="tag">${s.open===false?'Closed':'Open'}${s.capacity?` • ${(s.count||0)}/${s.capacity}`:''}</span></li>`;
      $('#listAccessible').innerHTML = acc.map(mkItem).join('') || '<li>—</li>';
      $('#listStandard').innerHTML  = std.map(mkItem).join('') || '<li>—</li>';
    }

    function selectShelter(s){
      const openTxt = (s.open===false)?'closed':'open';
      const accTxt = s.accessible ? ' • ♿ accessible' : '';
      $('#selShelter').textContent = `${s.name} • ${s.lat.toFixed(5)}, ${s.lng.toFixed(5)} • ${openTxt}${s.capacity? ' • '+(s.count||0)+'/'+s.capacity: ''}${accTxt}`;
      if(targetMarker){ targetMarker.setLatLng([s.lat,s.lng]) } else { targetMarker = L.marker([s.lat,s.lng], {title:s.name, opacity:.9}).addTo(map).bindPopup('🎯 '+escapeHtml(s.name)); }
      map.setView([s.lat,s.lng], 16);
      targetMarker.openPopup();
      targetMarker._shelter = s;
      delete targetMarker._med; // clear med selection mark
    }

    // ===== Medical supplements rendering
    function renderMedSupps(){
      medLayer.clearLayers();
      store.medSupps.forEach(med=>{
        const marker = L.marker([med.lat, med.lng], { title: med.name, icon: medIcon() });
        const notes = med.notes ? `<br/>Notes: ${escapeHtml(med.notes)}` : '';
        const contact = med.contact ? `<br/><a class='link' target='_blank' href='${med.contact}'>Contact</a>` : '';
        marker.bindPopup(
          `<b class="med">${escapeHtml(med.name)}</b> <span class="tag">${escapeHtml(med.type||'Supplement')}</span>${notes}${contact}
           <div style="margin-top:.4rem;display:flex;gap:.4rem;flex-wrap:wrap">
             <button class='btn' onclick="window._app.routeTo(${med.lat},${med.lng}, '${encodeURIComponent(med.name)}')">Route</button>
             <button class='btn' onclick="window._app.openInWaze(${med.lat},${med.lng})">Waze</button>
           </div>`
        );
        marker.on('click', ()=>{
          if(targetMarker){ targetMarker.setLatLng([med.lat, med.lng]) } else { targetMarker = L.marker([med.lat,med.lng]).addTo(map) }
          targetMarker.bindPopup('🎯 '+escapeHtml(med.name)).openPopup();
          targetMarker._med = med;
          delete targetMarker._shelter;
        });
        marker.addTo(medLayer);
      })
    }

    function renderMedList(){
      const ul = $('#listMeds');
      if(!store.medSupps.length){ ul.innerHTML = '<li>—</li>'; return; }
      ul.innerHTML = store.medSupps.map(m =>
        `<li>${escapeHtml(m.name)} <span class="tag">${escapeHtml(m.type||'Supplement')}</span>
          <button class="btn" style="margin-left:.4rem" onclick="window._app.routeTo(${m.lat},${m.lng}, '${encodeURIComponent(m.name)}')">Route</button>
        </li>`
      ).join('');
    }

    // ===== Distance + routing helpers
    function haversine(a,b){
      const toRad = d=>d*Math.PI/180, R=6371e3;
      const dLat = toRad(b[0]-a[0]), dLng = toRad(b[1]-a[1]);
      const lat1 = toRad(a[0]), lat2 = toRad(b[0]);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function buildWazeURL(lat,lng){ return `https://waze.com/ul?ll=${lat}%2C${lng}&navigate=yes`; }
    function buildGoogleURL(lat,lng){ return `https://www.google.com/maps/dir/?api=1&destination=${lat}%2C${lng}`; }

    function routeTo(lat,lng,nameEnc='Target'){
      if(!myPos){ toast('Locate yourself first'); return }
      router.setWaypoints([ L.latLng(myPos[0], myPos[1]), L.latLng(lat,lng) ]);
      router.show();
      if(targetMarker){ targetMarker.setLatLng([lat,lng]) } else { targetMarker = L.marker([lat,lng]).addTo(map) }
      targetMarker.bindPopup('🎯 '+decodeURIComponent(nameEnc)).openPopup();
      map.fitBounds(L.latLngBounds([myPos, [lat,lng]]), { padding:[40,40] });
    }
    function openInWaze(lat,lng){ window.open(buildWazeURL(lat,lng), '_blank'); }
    function openInGoogle(lat,lng){ window.open(buildGoogleURL(lat,lng), '_blank'); }
    function shareOne(lat,lng,nameEnc='Shared shelter'){
      const url = location.origin + location.pathname + `#shelter=${lat.toFixed(6)},${lng.toFixed(6)},${encodeURIComponent(decodeURIComponent(nameEnc))}`;
      navigator.clipboard?.writeText(url); toast('Share link copied');
    }

    // ===== Nearest selection logic
    function nearestFrom(list){
      if(!myPos){ toast('Locate yourself first'); return null }
      let best=null, bestD=Infinity; for(const s of list){ const d=haversine(myPos,[s.lat,s.lng]); if(d<bestD){bestD=d;best=s} }
      return best;
    }
    function findNearestShelter(){
      const pf = store.profile;
      const list = store.shelters;
      if(!list.length){ toast('Load data or add a shelter'); return null }
      if(pf.wheelchair){
        const acc = list.filter(s=> s.accessible === true);
        if(acc.length){ const best = nearestFrom(acc); if(best){ selectShelter(best); toast(`Nearest (accessible): ${best.name}`) } return best; }
        toast('No accessible shelters found nearby — showing nearest overall');
      }
      const best = nearestFrom(list);
      if(best){ selectShelter(best); toast(`Nearest: ${best.name}`) }
      return best;
    }
    function findNearestSuitableShelter(group){
      const pf = store.profile;
      let list = store.shelters.filter(s=> (s.open!==false) && (typeof s.capacity!=='number' || (s.count||0)+group <= s.capacity));
      if(!list.length) return null;
      if(pf.wheelchair){
        const acc = list.filter(s=> s.accessible === true);
        if(acc.length){ return nearestFrom(acc) }
        toast('No accessible shelters with enough space — picking nearest suitable overall');
      }
      return nearestFrom(list);
    }

    // Medical nearest by type (optional filter)
    function findNearestMed(typeFilter=''){
      let list = store.medSupps || [];
      if(!list.length){ toast('No medical supplements available yet'); return null; }
      if(typeFilter){ list = list.filter(m => (m.type||'').toLowerCase() === typeFilter.toLowerCase()); }
      if(!list.length){ toast('No items match that type'); return null; }
      return nearestFrom(list);
    }

    // ===== Arrival watcher (shelters)
    function watchArrivalAndPrompt(shelter, group){
      const timer = setInterval(async ()=>{
        try{ await locateMe(); }catch{}
        if(!myPos) return;
        const d = haversine(myPos, [shelter.lat, shelter.lng]);
        if(d <= 60){
          clearInterval(timer);
          if(confirm('Have you reached the shelter safely?')){
            shelter.count = Math.max(0,(shelter.count||0)+group);
            store.shelters = store.shelters.map(x=> x.id===shelter.id? {...x, count:shelter.count } : x);
            selectShelter(shelter);
            toast('Stay safe. Count updated.');
          }
        }
      }, 4000);
    }

    // ===== Instructions
    function showInstructions(){
      const d = $('#dlgInstructions');
      d.showModal();
      $('#btnCloseInstr').onclick = ()=> d.close();
    }

    // ===== Contacts and “I'm safe” (mock only)
    $('#contactsInput').value = store.contacts;
    $('#btnSaveContacts').addEventListener('click', ()=>{ store.contacts = $('#contactsInput').value.trim(); toast('Contacts saved') });
    $('#btnSafe').addEventListener('click', ()=>{
      const when = new Date().toLocaleString();
      $('#safeStatus').textContent = `Status: sent successfully (${when})`;
      toast('Sent successfully');
    });
    $('#btnWhatsApp').addEventListener('click', ()=>{
      const txt = encodeURIComponent(`I'm safe ✅ (Shelter Finder). Time: ${new Date().toLocaleString()}`);
      window.open(`https://wa.me/?text=${txt}`, '_blank');
    });

    // ===== Parse/load helpers
    const JERUSALEM_DATA_URL = 'https://jerusalem.datacity.org.il/dataset/3e97d0fc-4268-4aea-844d-12588f55d809/resource/631d161f-c929-4614-a9d5-9e4eef953877/download/data.geojson';

    function parseAny(text){
      const t = text.trim();
      try{
        const j=JSON.parse(t);
        if(Array.isArray(j)) return j;
        if(j && j.type==='FeatureCollection'){
          return j.features.map(f=>{
            const c=f.geometry?.coordinates; const p=f.properties||{};
            if(!c||f.geometry.type!=='Point') return null;
            return {
              id: crypto.randomUUID(),
              name: p.name||p.title||p.Name||'Shelter',
              lat: c[1], lng: c[0],
              capacity: parseInt(p.capacity||p.Capacity||p.CAPACITY||''),
              contact: p.contact||p.Contact||'',
              accessible: !!(p.accessible||p.Accessible||p.wheelchair||p.Wheelchair),
              open: (p.open ?? true),
              count: parseInt(p.count||'')||0
            };
          }).filter(Boolean)
        }
      }catch{}
      if(/^(name|lat|lng|latitude|longitude)/i.test(t)){
        const lines=t.split(/\r?\n/).filter(Boolean);
        const headers=lines.shift().split(',').map(h=>h.trim().toLowerCase());
        const idxName=headers.findIndex(h=>/name/.test(h));
        const idxLat=headers.findIndex(h=>/lat|latitude/.test(h));
        const idxLng=headers.findIndex(h=>/lng|lon|longitude/.test(h));
        const idxCap=headers.findIndex(h=>/cap/.test(h));
        const idxContact=headers.findIndex(h=>/contact|phone|tel/.test(h));
        const idxAcc=headers.findIndex(h=>/access/i.test(h));
        return lines.map(row=>{
          const cols=row.split(',');
          return {
            id: crypto.randomUUID(),
            name: cols[idxName]||'Shelter',
            lat: parseFloat(cols[idxLat]),
            lng: parseFloat(cols[idxLng]),
            capacity: parseInt(cols[idxCap]||''),
            contact: cols[idxContact]||'',
            accessible: idxAcc>=0 ? ['true','1','yes','y'].includes(String(cols[idxAcc]||'').toLowerCase()) : false,
            open:true, count:0
          };
        }).filter(x=>Number.isFinite(x.lat)&&Number.isFinite(x.lng));
      }
      throw new Error('Unsupported format');
    }
    async function fetchFromUrl(url){ const res = await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status); const text = await res.text(); return parseAny(text); }
    function mergeShelters(items){
      if(!Array.isArray(items)||!items.length) throw new Error('No items');
      const list = store.shelters.slice(); let added=0;
      for(const it of items){
        if(Number.isFinite(it.lat)&&Number.isFinite(it.lng)){
          list.push({
            id: it.id||crypto.randomUUID(),
            name: it.name||'Shelter',
            lat: it.lat, lng: it.lng,
            capacity: it.capacity,
            contact: it.contact,
            photoUrl: it.photoUrl,
            accessible: !!it.accessible,
            open: (it.open!==false),
            count: it.count||0
          });
          added++;
        }
      }
      store.shelters = list;
      return added;
    }

    // ===== Mock data (nationwide)
    const israelMock = [
      // Tel Aviv & Center
      {name:'Shelter – Tel Aviv Dizengoff', lat:32.0755, lng:34.7749, capacity:80,  open:true,  count:20, accessible:true},
      {name:'Shelter – Tel Aviv Azrieli',  lat:32.0740, lng:34.7927, capacity:120, open:true,  count:35, accessible:true},
      {name:'Shelter – Tel Aviv Florentin',lat:32.0565, lng:34.7708, capacity:60,  open:true,  count:18, accessible:false},
      {name:'Shelter – Ramat Gan Center',  lat:32.0826, lng:34.8141, capacity:60,  open:true,  count:10, accessible:false},
      {name:'Shelter – Givatayim',         lat:32.0723, lng:34.8082, capacity:50,  open:true,  count:8,  accessible:false},
      {name:'Shelter – Petah Tikva',       lat:32.0871, lng:34.8853, capacity:90,  open:true,  count:14, accessible:true},
      {name:'Shelter – Rishon LeZion',     lat:31.9646, lng:34.8044, capacity:110, open:true,  count:30, accessible:false},
      {name:'Shelter – Holon Wolfson',     lat:32.0100, lng:34.7799, capacity:70,  open:true,  count:16, accessible:true},
      {name:'Shelter – Bat Yam Beach',     lat:32.0154, lng:34.7442, capacity:80,  open:false, count:0,  accessible:true},
      // Jerusalem
      {name:'Shelter – Jerusalem Central Bus Station', lat:31.7894, lng:35.2024, capacity:150, open:true,  count:40, accessible:true},
      {name:'Shelter – Jerusalem German Colony',       lat:31.7610, lng:35.2226, capacity:60,  open:true,  count:12, accessible:false},
      {name:'Shelter – Jerusalem French Hill',         lat:31.8067, lng:35.2360, capacity:70,  open:true,  count:15, accessible:true},
      {name:'Shelter – Jerusalem Mahane Yehuda',       lat:31.7842, lng:35.2137, capacity:90,  open:true,  count:22, accessible:true},
      {name:'Shelter – Jerusalem Talpiyot',            lat:31.7518, lng:35.2197, capacity:60,  open:false, count:0,  accessible:false},
      // Haifa & North
      {name:'Shelter – Haifa Hadar',       lat:32.8090, lng:34.9984, capacity:90,  open:true,  count:18, accessible:true},
      {name:'Shelter – Haifa Bat Galim',   lat:32.8303, lng:34.9721, capacity:80,  open:true,  count:10, accessible:false},
      {name:'Shelter – Haifa Carmel',      lat:32.7897, lng:34.9896, capacity:70,  open:true,  count:9,  accessible:true},
      {name:'Shelter – Nahariya',          lat:33.0074, lng:35.0998, capacity:70,  open:true,  count:9,  accessible:true},
      {name:'Shelter – Acre Old City',     lat:32.9236, lng:35.0713, capacity:60,  open:true,  count:11, accessible:false},
      {name:'Shelter – Tiberias Lakeside', lat:32.7922, lng:35.5313, capacity:60,  open:true,  count:7,  accessible:false},
      {name:'Shelter – Afula Center',      lat:32.6073, lng:35.2899, capacity:70,  open:true,  count:8,  accessible:true},
      {name:'Shelter – Karmiel',           lat:32.9184, lng:35.2900, capacity:65,  open:true,  count:10, accessible:true},
      {name:'Shelter – Kiryat Shmona',     lat:33.2070, lng:35.5721, capacity:80,  open:true,  count:19, accessible:false},
      // South
      {name:'Shelter – Ashdod Center',     lat:31.8015, lng:34.6434, capacity:120, open:true,  count:25, accessible:true},
      {name:'Shelter – Ashkelon Marina',   lat:31.6667, lng:34.5553, capacity:90,  open:true,  count:20, accessible:false},
      {name:'Shelter – Beersheba Old City',lat:31.2520, lng:34.7915, capacity:100, open:true,  count:28, accessible:true},
      {name:'Shelter – Sderot',            lat:31.5241, lng:34.5953, capacity:80,  open:true,  count:22, accessible:true},
      {name:'Shelter – Netivot',           lat:31.4229, lng:34.5842, capacity:70,  open:true,  count:17, accessible:false},
      {name:'Shelter – Ofakim',            lat:31.3144, lng:34.6204, capacity:75,  open:false, count:0,  accessible:true},
      {name:'Shelter – Eilat North',       lat:29.5620, lng:34.9563, capacity:90,  open:true,  count:12, accessible:true},
      // Sharon / Coastal Plain
      {name:'Shelter – Herzliya Pituach',  lat:32.1634, lng:34.8056, capacity:80,  open:true,  count:16, accessible:false},
      {name:'Shelter – Netanya Kikar HaAtzmaut', lat:32.3310, lng:34.8569, capacity:120, open:true, count:22, accessible:true},
      {name:'Shelter – Kfar Saba',         lat:32.1775, lng:34.9066, capacity:70,  open:true,  count:12, accessible:true},
      {name:'Shelter – Ra’anana Park',     lat:32.1848, lng:34.8707, capacity:90,  open:true,  count:18, accessible:false},
      {name:'Shelter – Hadera Station',    lat:32.4364, lng:34.9196, capacity:85,  open:true,  count:14, accessible:true},
      {name:'Shelter – Caesarea',          lat:32.5006, lng:34.8926, capacity:60,  open:true,  count:9,  accessible:false},
      // Additional cities
      {name:'Shelter – Modi’in Center',    lat:31.9000, lng:35.0104, capacity:100, open:true,  count:26, accessible:true},
      {name:'Shelter – Rehovot Weizmann',  lat:31.8948, lng:34.8113, capacity:80,  open:true,  count:15, accessible:false},
      {name:'Shelter – Lod',               lat:31.9513, lng:34.8880, capacity:70,  open:true,  count:10, accessible:true},
      {name:'Shelter – Ramla',             lat:31.9316, lng:34.8656, capacity:70,  open:true,  count:11, accessible:false},
      {name:'Shelter – Beit Shemesh',      lat:31.7480, lng:34.9880, capacity:75,  open:true,  count:13, accessible:true},
      {name:'Shelter – Raanana East',      lat:32.1831, lng:34.8872, capacity:85,  open:false, count:0,  accessible:true}
    ];

    const sampleShelters=[
      {name:'Public shelter – Tel Aviv (Dizengoff Sq.)', lat:32.0755, lng:34.7749, capacity:50, open:true, count:10, accessible:true},
      {name:'Public shelter – Jerusalem (CBS area)',     lat:31.7894, lng:35.2024, capacity:80, open:true, count:25, accessible:false},
      {name:'Public shelter – Haifa (Hadar)',            lat:32.8090, lng:34.9984, capacity:60, open:true, count:5,  accessible:true}
    ];

    // Buttons to load/clear data
    $('#btnLoadIsraelMock').addEventListener('click', ()=>{
      const list = (store.shelters||[]).concat(israelMock.map(s=>({id:crypto.randomUUID(), ...s})));
      store.shelters = list;
      toast('Israel mock loaded: '+israelMock.length);
    });
    $('#btnLoadJerusalem').addEventListener('click', async ()=>{
      try{ const items=await fetchFromUrl(JERUSALEM_DATA_URL); const added=mergeShelters(items); toast('Jerusalem dataset loaded: '+added) }
      catch(err){ toast('Load failed: '+err.message+' (CORS? try Import file or Paste)') }
    });
    $('#btnLoadSample').addEventListener('click', ()=>{
      const list=(store.shelters||[]).concat(sampleShelters.map(s=>({id:crypto.randomUUID(),...s})));
      store.shelters = list; toast('Tiny sample added');
    });
    $('#btnClearShelters').addEventListener('click', ()=>{
      if(confirm('Clear all saved shelters?')){ store.shelters=[]; toast('Cleared') }
    });
    $('#btnFetchUrl').addEventListener('click', async ()=>{
      const url=$('#urlInput').value.trim(); if(!url){ toast('Enter a URL'); return }
      try{ const items=await fetchFromUrl(url); const added=mergeShelters(items); toast('Loaded '+added) }
      catch(err){ toast('Load failed: '+err.message) }
    });
    $('#btnImport').addEventListener('click', ()=> $('#fileImport').click());
    $('#fileImport').addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return; const txt=await f.text();
      try{ const items=parseAny(txt); const added=mergeShelters(items); toast('Imported '+added) }
      catch(err){ toast('Import failed: '+err.message) }
    });
    $('#btnParsePaste').addEventListener('click', ()=>{
      const raw=$('#pasteBox').value; if(!raw){ toast('Paste JSON/CSV first'); return }
      try{ const items=parseAny(raw); const added=mergeShelters(items); toast('Added '+added) }
      catch(err){ toast('Parse failed: '+err.message) }
    });

    // ===== Add shelter workflow (photo optional)
    let pickMode = null; // {kind:'shelter'|'med', latEl, lngEl}
    $('#btnAddShelter').addEventListener('click', ()=> $('#dlgAdd').showModal());
    $('#btnUseGPS').addEventListener('click', async ()=>{ try{ const p=await locateMe(true); if(p){ $('#lat').value=p[0].toFixed(6); $('#lng').value=p[1].toFixed(6); toast('GPS set for shelter') } }catch{} });
    $('#btnPickOnMap').addEventListener('click', ()=>{ pickMode={kind:'shelter', latEl:'#lat', lngEl:'#lng'}; toast('Double-click on the map to choose a location'); $('#dlgAdd').close(); });
    map.on('dblclick', (e)=>{ if(!pickMode) return; $(pickMode.latEl).value=e.latlng.lat.toFixed(6); $(pickMode.lngEl).value=e.latlng.lng.toFixed(6); toast('Coordinates set'); const k=pickMode.kind; pickMode=null; if(k==='shelter') $('#dlgAdd').showModal(); if(k==='med') $('#dlgAddMed').showModal(); });
    $('#btnSaveShelter').addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const name=$('#name').value.trim(); const lat=parseFloat($('#lat').value); const lng=parseFloat($('#lng').value); const capacity=parseInt($('#capacity').value||''); const contact=$('#contact').value.trim();
      const accessible=$('#accessibleChk').checked;
      let photoUrl=''; const file=$('#photo').files?.[0]; if(file){ photoUrl=await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
      if(!name||!Number.isFinite(lat)||!Number.isFinite(lng)){ toast('Fill name & coordinates'); return }
      const list=(store.shelters||[]);
      list.push({ id: crypto.randomUUID(), name, lat, lng, capacity: Number.isFinite(capacity)?capacity:undefined, contact, photoUrl, accessible, open:true, count:0, owner:(store.user||{}).uid||'local' });
      store.shelters = list;
      selectShelter(list[list.length-1]); $('#dlgAdd').close(); toast('Shelter added');
    });

    // ===== Account (demo)
    $('#btnRegister').addEventListener('click', ()=>{
      const email=$('#email').value.trim(); const name=$('#displayName').value.trim();
      if(!email){ toast('Enter email'); return }
      store.user={ uid: crypto.randomUUID(), email, name: name||'User', verified:false };
      toast('Registered (demo). Admin verification pending.');
    });

    // ===== Profile
    function syncProfileUI(){
      const pf = store.profile;
      $('#wheelchairChk').checked = !!pf.wheelchair;
      $('#lowVisionChk').checked  = !!pf.lowVision;
      $('#healthNotes').value     = pf.healthNotes||'';
    }
    $('#btnSaveProfile').addEventListener('click', ()=>{
      store.profile = {
        wheelchair: $('#wheelchairChk').checked,
        lowVision:  $('#lowVisionChk').checked,
        healthNotes: $('#healthNotes').value.trim()
      };
      toast('Profile saved');
    });

    // ===== UI buttons (shelter)
    $('#btnLocate').addEventListener('click', ()=> locateMe(true));
    $('#btnNearest').addEventListener('click', ()=>{
      const s=findNearestShelter(); if(s) selectShelter(s);
    });
    $('#btnRoute').addEventListener('click', ()=>{
      if(!(targetMarker && myPos)){ toast('Need location & a target selected'); return }
      const {lat,lng}=targetMarker.getLatLng(); routeTo(lat,lng, encodeURIComponent(targetMarker._shelter?.name||targetMarker._med?.name||'Target'))
    });
    $('#btnWaze').addEventListener('click', ()=>{
      if(!targetMarker){ toast('Pick a target first'); return }
      const {lat,lng}=targetMarker.getLatLng(); openInWaze(lat,lng)
    });
    $('#btnGmaps').addEventListener('click', ()=>{
      if(!targetMarker){ toast('Pick a target first'); return }
      const {lat,lng}=targetMarker.getLatLng(); openInGoogle(lat,lng)
    });
    $('#btnShareLink').addEventListener('click', ()=>{
      if(!targetMarker){ toast('Pick a shelter first'); return }
      const s=targetMarker._shelter||{ name:'Shared shelter', ...targetMarker.getLatLng() };
      shareOne(s.lat||s.latlng?.lat||targetMarker.getLatLng().lat, s.lng||s.latlng?.lng||targetMarker.getLatLng().lng, encodeURIComponent(s.name))
    });
    $('#btnToggleOpen').addEventListener('click', ()=>{
      if(!(targetMarker && targetMarker._shelter)){ toast('Pick a shelter first'); return }
      const s=targetMarker._shelter; s.open=(s.open===false)?true:false;
      store.shelters = store.shelters.map(x=> x.id===s.id? {...x, open:s.open }:x);
      selectShelter(s); toast('Status: '+(s.open===false?'Closed':'Open'));
    });
    $('#btnUpdateCount').addEventListener('click', ()=>{
      if(!(targetMarker && targetMarker._shelter)){ toast('Pick a shelter first'); return }
      const s=targetMarker._shelter;
      const incr=parseInt(prompt('How many people arrived with you (including you)?', String(parseInt($('#groupSize')?.value||'1')||1))||'');
      if(!Number.isFinite(incr)||incr<=0) return;
      s.count=Math.max(0,(s.count||0)+incr);
      store.shelters = store.shelters.map(x=> x.id===s.id? {...x, count:s.count }:x);
      selectShelter(s); toast('Updated count +'+incr);
    });
    $('#btnRefreshLists').addEventListener('click', ()=> { renderShelterLists(); renderMedList(); });

    // ===== Emergency
    $('#btnEmergency').addEventListener('click', async ()=>{
      try{ if(!myPos) await locateMe(true); }catch{}
      if(!myPos){ toast('Cannot get GPS. Make sure to click Allow.'); return }
      const group=Math.max(1, parseInt($('#groupSize')?.value||'1'));
      const s=findNearestSuitableShelter(group);
      if(!s){ showInstructions(); return }
      selectShelter(s); routeTo(s.lat, s.lng, encodeURIComponent(s.name)); watchArrivalAndPrompt(s, group);
    });

    // ===== Medical: Add
    $('#btnAddMed').addEventListener('click', ()=> $('#dlgAddMed').showModal());
    $('#btnUseGPSMed').addEventListener('click', async ()=>{ try{ const p=await locateMe(true); if(p){ $('#medLat').value=p[0].toFixed(6); $('#medLng').value=p[1].toFixed(6); toast('GPS set for medical item') } }catch{} });
    $('#btnPickOnMapMed').addEventListener('click', ()=>{ pickMode={kind:'med', latEl:'#medLat', lngEl:'#medLng'}; toast('Double-click on the map to choose a location'); $('#dlgAddMed').close(); });
    $('#btnSaveMed').addEventListener('click', (ev)=>{
      ev.preventDefault();
      const name=$('#medName').value.trim();
      const type=$('#medType').value.trim();
      const notes=$('#medNotes').value.trim();
      const contact=$('#medContact').value.trim();
      const lat=parseFloat($('#medLat').value); const lng=parseFloat($('#medLng').value);
      if(!name || !type || !Number.isFinite(lat) || !Number.isFinite(lng)){ toast('Fill name, type, and coordinates'); return }
      const list = store.medSupps.slice();
      list.push({ id: crypto.randomUUID(), name, type, notes, contact, lat, lng, owner:(store.user||{}).uid||'local' });
      store.medSupps = list;
      $('#dlgAddMed').close();
      toast('Medical supplement added');
    });

    // ===== Medical: Need
    function fillTypeFilter(){
      const sel = $('#medTypeFilter');
      const types = Array.from(new Set((store.medSupps||[]).map(m=>(m.type||'').trim()).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">All types</option>` + types.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }
    function renderNeedMedList(){
      const ul = $('#needMedList');
      const type = $('#medTypeFilter').value.trim();
      let items = store.medSupps||[];
      if(type) items = items.filter(m=> (m.type||'').toLowerCase() === type.toLowerCase());
      if(!items.length){ ul.innerHTML = '<li>No items yet</li>'; return; }
      ul.innerHTML = items.map(m=>`
        <li>${escapeHtml(m.name)} <span class="tag">${escapeHtml(m.type)}</span>
          <button class="btn" style="margin-left:.4rem" onclick="window._app.routeTo(${m.lat},${m.lng}, '${encodeURIComponent(m.name)}')">Route</button>
        </li>`).join('');
    }
    $('#btnNeedMed').addEventListener('click', ()=>{
      fillTypeFilter(); renderNeedMedList();
      $('#dlgNeedMed').showModal();
    });
    $('#medTypeFilter').addEventListener('change', renderNeedMedList);
    $('#btnNearestMed').addEventListener('click', async ()=>{
      try{ if(!myPos) await locateMe(true); }catch{}
      if(!myPos){ toast('Cannot get GPS. Make sure to click Allow.'); return }
      const type = $('#medTypeFilter').value.trim();
      const m = findNearestMed(type);
      if(!m) return;
      routeTo(m.lat, m.lng, encodeURIComponent(m.name));
      const popup = L.popup().setLatLng([m.lat,m.lng]).setContent('🎯 '+escapeHtml(m.name)).openOn(map);
      toast(`Nearest ${type||'item'}: ${m.name}`);
    });
    $('#btnCloseNeed').addEventListener('click', ()=> $('#dlgNeedMed').close());

    // ===== Map quick select (kept): double-click handled earlier for pickMode

    // ===== Share link hash
    function tryParseHash(){
      if(location.hash.startsWith('#shelter=')){
        const raw=location.hash.replace('#shelter=',''); const [latS,lngS,nameEnc='Shared shelter']=raw.split(',');
        const lat=parseFloat(latS), lng=parseFloat(lngS);
        if(Number.isFinite(lat)&&Number.isFinite(lng)){ selectShelter({name: decodeURIComponent(nameEnc), lat, lng}); toast('Loaded shared shelter'); }
      }
    }

    function escapeHtml(str){ return String(str).replace(/[&<>"']+/g, s=> ({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[s])) }

    // ===== Expose for popup buttons
    window._app = { routeTo, openInWaze, shareOne };

    // ===== Boot
    (async function boot(){
      tryParseHash();
      try{ await locateMe(true); }catch{}
      $('#contactsInput').value = store.contacts;
      syncProfileUI();
      renderShelters(); renderShelterLists();
      renderMedSupps(); renderMedList();
      statusPill('ready','✅');
    })();
  </script>
</body>
</html>
